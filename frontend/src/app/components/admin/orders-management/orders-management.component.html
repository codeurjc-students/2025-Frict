<div class="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
  <div class="max-w-[95%] xl:max-w-[83%] mx-auto p-4 py-8">

    <div class="mb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-yellow-600">Gestor de Pedidos</h1>
        <p class="text-slate-500">Gestiona los pedidos realizados online de la organización.</p>
      </div>

      <p-selectButton [options]="displayMode" [(ngModel)]="listModeSelected" optionLabel="label" optionValue="value" aria-labelledby="basic" />
    </div>

    <div cdkDropListGroup class="flex flex-col gap-8">

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-start">
        @for (col of kanbanColumns; track col.id) {
          <div class="bg-slate-100/50 rounded-2xl p-4 border border-slate-200 flex flex-col h-[600px] min-w-0">

            <div class="flex items-center justify-between mb-4 px-1 shrink-0">
              <h3 class="font-bold text-slate-700 truncate mr-2">{{ col.title }}</h3>
              <span class="bg-slate-200 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full shrink-0">{{ col.data().length }}</span>
            </div>

            <div cdkDropList [cdkDropListData]="col.data()" (cdkDropListDropped)="drop($event, col.id)"
                 class="flex-grow overflow-y-auto custom-scrollbar flex flex-col gap-3 min-h-[100px] pb-4 pr-1">

              @for (order of col.data(); track order.id) {

                <div cdkDrag (click)="openOrderDetails(order)" class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm cursor-grab active:cursor-grabbing hover:border-blue-400 hover:shadow-md transition-all w-full min-w-0">
                  <div class="flex justify-between items-start mb-2 pointer-events-none">
                    <div class="flex items-center gap-2 min-w-0 mr-2">
                      <i class="pi pi-stop-circle text-sm shrink-0" [ngClass]="getStatusColor(order.status)"></i>
                      <span class="text-xs font-mono text-slate-500 font-medium truncate">{{ order.referenceCode }}</span>
                    </div>
                    <p-avatar [label]="order.user.name.charAt(0)" shape="circle" size="normal" styleClass="w-6 h-6 bg-slate-200 text-slate-600 text-xs shrink-0"></p-avatar>
                  </div>
                  <div class="font-bold text-slate-800 text-sm mb-1 truncate pointer-events-none">{{ order.user.name }}</div>
                  <div class="text-xs text-slate-500 mb-4 truncate pointer-events-none">
                    <i class="pi pi-map-marker text-[10px] mr-1 shrink-0"></i>{{ order.address }}
                  </div>
                  <div class="flex flex-wrap gap-2 items-center pointer-events-none">
                    <span class="px-2.5 py-1 rounded-full bg-green-50 text-green-700 text-[10px] font-bold border border-green-200 flex items-center gap-1 shrink-0">
                      <i class="pi pi-box text-[9px]"></i> {{ order.totalItems }}
                    </span>
                    @if(order.assignedTruck) {
                      <span class="px-2.5 py-1 rounded-full bg-blue-50 text-blue-700 text-[10px] font-bold border border-blue-200 flex items-center gap-1 shrink-0 truncate max-w-full">
                        <span class="w-3 h-3 rounded-full bg-blue-600 text-white flex items-center justify-center text-[7px] font-black shrink-0">M</span>
                        <span class="truncate">{{ order.assignedTruck.reference }}</span>
                      </span>
                    } @else {
                      <span class="px-2.5 py-1 rounded-full bg-slate-50 text-slate-500 text-[10px] font-bold border border-slate-200 flex items-center gap-1 shrink-0">
                        <i class="pi pi-exclamation-triangle text-[9px]"></i> Sin Camión
                      </span>
                    }
                    <span class="px-2.5 py-1 rounded-full bg-slate-100 text-slate-600 text-[10px] font-bold border border-slate-200 ml-auto shrink-0">
                      {{ order.totalCost | currency:'EUR' }}
                    </span>
                  </div>
                  <div *cdkDragPlaceholder class="bg-slate-200/50 border-2 border-dashed border-slate-400 rounded-xl min-h-[140px] w-full opacity-60"></div>
                  <div *cdkDragPreview class="bg-white border-2 border-blue-400 rounded-xl p-4 shadow-2xl w-[280px] opacity-95 rotate-2 cursor-grabbing">
                    <span class="text-xs font-mono text-slate-500">{{ order.referenceCode }}</span>
                    <div class="font-bold text-slate-800 text-sm truncate mt-1">{{ order.user.name }}</div>
                  </div>
                </div>

              }
            </div>
          </div>
        }
      </div>

      <div class="bg-red-50/50 rounded-2xl p-5 border border-red-100 shadow-sm min-w-0 mt-4">
        <div class="flex items-center justify-start gap-3 mb-4 px-1">
          <i class="pi pi-times-circle text-red-500 text-xl"></i>
          <h3 class="font-bold text-red-900">Cancelados</h3>
          <span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-0.5 rounded-full">{{ cancelledOrders().length }}</span>
        </div>
        <div cdkDropList [cdkDropListData]="cancelledOrders()" (cdkDropListDropped)="drop($event, 'CANCELLED')" class="flex flex-wrap gap-4 min-h-[100px] p-2 bg-white/50 rounded-xl border border-red-50/50 border-dashed">
          @for (order of cancelledOrders(); track order.id) {
            <div cdkDrag (click)="openOrderDetails(order)" class="w-full sm:w-[280px] md:w-[300px] shrink-0 bg-white border border-slate-200 rounded-xl p-4 shadow-sm cursor-grab active:cursor-grabbing hover:border-red-400 transition-colors min-w-0">
              <div class="flex items-center gap-2 mb-2"><i class="pi pi-stop-circle text-sm text-red-500"></i><span class="text-xs font-mono text-slate-500">{{ order.referenceCode }}</span></div>
              <div class="font-bold text-slate-800 text-sm mb-1 truncate">{{ order.user.name }}</div>
              <div class="flex flex-wrap gap-2 items-center mt-4">
                <span class="px-2.5 py-1 rounded-full bg-slate-100 text-slate-600 text-[10px] font-bold border border-slate-200">{{ order.totalCost | currency:'EUR' }}</span>
              </div>
              <div *cdkDragPlaceholder class="bg-red-100/50 border-2 border-dashed border-red-300 rounded-xl min-h-[140px] w-full sm:w-[280px] opacity-60"></div>
            </div>
          }
        </div>
      </div>

    </div>
  </div>
</div>


<p-dialog
  [(visible)]="displayOrderDialog"
  [modal]="true"
  [breakpoints]="{'1199px': '75vw', '991px': '90vw', '575px': '100vw'}"
  [style]="{width: '1000px', 'max-height': '95vh'}"
  [draggable]="false"
  [resizable]="false"
  styleClass="order-details-dialog custom-dialog-scroll">

  <ng-template pTemplate="header">
    @if (selectedOrder) {
      <div class="flex flex-col gap-2 w-full pr-8">
        <div class="flex items-center gap-3">
          <h2 class="text-2xl font-bold text-slate-800">Pedido {{ selectedOrder.referenceCode }}</h2>
          <span class="text-lg font-normal text-slate-400">#{{ selectedOrder.id }}</span>
        </div>
        <div class="flex items-center gap-3 mt-1">
                    <span class="px-3 py-1 rounded-full text-xs font-bold border flex items-center gap-1.5"
                          [ngClass]="getStatusBgColor(selectedOrder.status)">
                        <i class="pi pi-circle-fill text-[8px]"></i>
                      {{ getStatusLabel(selectedOrder.status) }}
                    </span>
          <span class="text-xs text-slate-500">
                        Creado el {{ selectedOrder.date | date:'mediumDate' }} por <span class="font-bold text-slate-700">{{ selectedOrder.user.name }}</span>
                    </span>
        </div>
      </div>
    }
  </ng-template>

  @if (selectedOrder) {
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 pt-4 pb-2">

      <div class="lg:col-span-2 flex flex-col gap-8">

        <div class="border border-slate-200 rounded-xl overflow-hidden bg-white">
          <div class="bg-slate-50 border-b border-slate-200 px-4 py-3 flex justify-between items-center">
            <h3 class="font-bold text-slate-700 text-sm">Artículos del Pedido ({{ selectedOrder.totalItems }})</h3>
          </div>
          <div class="p-0">
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-50/50 text-slate-500 text-xs border-b border-slate-100">
              <tr>
                <th class="px-4 py-2 font-medium">Producto</th>
                <th class="px-4 py-2 font-medium text-center">Cant.</th>
                <th class="px-4 py-2 font-medium text-right">Precio</th>
              </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                @for (prod of selectedOrder.products; track prod.name) {
                  <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 font-medium text-slate-700">{{ prod.name }}</td>
                    <td class="px-4 py-3 text-center"><span class="bg-slate-100 px-2 py-0.5 rounded text-xs text-slate-600">{{ prod.quantity }}</span></td>
                    <td class="px-4 py-3 text-right text-slate-600">{{ prod.price | currency:'EUR' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <div>
          <h3 class="font-bold text-slate-800 text-sm mb-4 border-b border-slate-200 pb-2">Actividad y Comentarios</h3>

          <div class="relative pl-4 border-l-2 border-slate-200 ml-4 space-y-6">
            @for (log of selectedOrder.history; track log.date) {

              <div class="relative">
                <div class="absolute -left-[25px] bg-white w-6 h-6 rounded-full border-2 flex items-center justify-center"
                     [ngClass]="log.isDriverComment ? 'border-yellow-400 text-yellow-500' : 'border-slate-300 text-slate-400'">
                  <i class="text-[10px]" [ngClass]="log.isDriverComment ? 'pi pi-comment' : 'pi pi-check'"></i>
                </div>

                <div class="bg-white border rounded-xl p-3 shadow-sm"
                     [ngClass]="log.isDriverComment ? 'border-yellow-200 bg-yellow-50/30' : 'border-slate-200'">
                  <div class="flex justify-between items-start mb-1">
                                        <span class="text-xs font-bold" [ngClass]="log.isDriverComment ? 'text-yellow-800' : 'text-slate-700'">
                                            {{ log.isDriverComment ? 'Nota del Conductor' : getStatusLabel(log.status) }}
                                        </span>
                    <span class="text-[10px] text-slate-400">{{ log.date | date:'short' }}</span>
                  </div>
                  <p class="text-sm text-slate-600 leading-relaxed">{{ log.description }}</p>
                </div>
              </div>

            }
          </div>
        </div>
      </div>

      <div class="lg:col-span-1 flex flex-col gap-6">

        <div>
          <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Cliente Asignado</h4>
          <div class="flex items-center gap-3">
            <p-avatar [label]="selectedOrder.user.name.charAt(0)" shape="circle" size="large" styleClass="bg-blue-100 text-blue-700 font-bold"></p-avatar>
            <div>
              <p class="text-sm font-bold text-slate-800">{{ selectedOrder.user.name }}</p>
              <p class="text-xs text-slate-500">{{ selectedOrder.user.email }}</p>
            </div>
          </div>
        </div>

        <hr class="border-slate-200">

        <div>
          <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Logística</h4>
          @if(selectedOrder.assignedTruck) {
            <div class="flex items-center justify-between group cursor-pointer">
              <div class="flex items-center gap-2 text-sm text-slate-700 font-medium">
                <i class="pi pi-truck text-slate-400"></i> {{ selectedOrder.assignedTruck.reference }}
              </div>
              <i class="pi pi-cog text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <p class="text-xs text-slate-400 mt-1 ml-6 pl-1">Matrícula: {{ selectedOrder.assignedTruck.plate }}</p>
          } @else {
            <div class="text-sm text-slate-500 flex items-center gap-2">
              <i class="pi pi-exclamation-triangle text-amber-500"></i> Sin asignar
            </div>
          }
        </div>

        <hr class="border-slate-200">

        <div>
          <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Resumen Económico</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between text-slate-600">
              <span>Artículos ({{ selectedOrder.totalItems }})</span>
            </div>
            <div class="flex justify-between font-bold text-slate-800 text-lg pt-2 border-t border-slate-100 mt-2">
              <span>Total</span>
              <span>{{ selectedOrder.totalCost | currency:'EUR' }}</span>
            </div>
          </div>
        </div>

        <hr class="border-slate-200">

        <div>
          <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Dirección de Entrega</h4>
          <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-sm text-slate-700 flex items-start gap-2">
            <i class="pi pi-map-marker mt-0.5 text-slate-400"></i>
            <span>{{ selectedOrder.address }}</span>
          </div>
        </div>

      </div>
    </div>
  }
</p-dialog>
