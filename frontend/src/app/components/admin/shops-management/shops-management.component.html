<div *ngIf="loading || error">
  <app-loading-screen [loading]="loading" [error]="error"></app-loading-screen>
</div>

<div *ngIf="!loading && !error" class="min-h-screen bg-slate-50 font-sans text-slate-800">

  <div class="max-w-[95%] xl:max-w-[83%] mx-auto p-4 py-8">

    <div class="mb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-yellow-600">Gestor de Tiendas</h1>
        <p class="text-slate-500">Administra las diferentes puntos de venta de la organizaci贸n.</p>
      </div>

      <div>
        <p-button routerLink="/admin/shops/new" label="Nueva Tienda" icon="pi pi-plus" styleClass="p-button-warning" rounded="true"></p-button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">

      <div class="lg:col-span-3 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col h-[400px] lg:h-[500px] relative">
        <div class="absolute top-4 left-4 z-[400] bg-white/90 backdrop-blur-sm px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm">
          <h3 class="font-bold text-slate-700 text-xs flex items-center gap-2">
            <i class="pi pi-map text-green-600"></i> Mapa de tiendas
          </h3>
        </div>

        <div id="map" class="flex-grow w-full min-h-0 bg-slate-100"></div>
      </div>

      <div class="lg:col-span-2 bg-white border border-slate-200 rounded-2xl shadow-sm p-5 flex flex-col h-full">

        <div class="flex items-center gap-5 p-6 bg-slate-50 border border-slate-100 rounded-xl mb-6 relative overflow-hidden shrink-0">
          <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-100 rounded-full blur-xl opacity-60"></div>

          <div class="w-16 h-16 shrink-0 bg-white rounded-full shadow-sm flex items-center justify-center z-10 border border-slate-100">
            <i class="pi pi-shop text-3xl text-yellow-500" style="font-size: 1.5rem"></i>
          </div>

          <div class="flex flex-col z-10">
            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tiendas Totales</span>

            <div class="flex items-center gap-3 mt-1">
              <span class="text-4xl font-extrabold text-slate-800">{{ shopsPage.totalItems }}</span>
            </div>
          </div>
        </div>

        <div class="flex-grow flex flex-col min-h-0">
          <div class="flex justify-between items-center mb-3 shrink-0">
            <h3 class="font-bold text-slate-700 text-sm">Notificaciones relacionadas (todas las tiendas)</h3>
            <button class="text-xs text-cyan-600 font-bold hover:underline">Ver todas</button>
          </div>

          <div class="flex flex-col gap-2 overflow-y-auto max-h-[380px] pr-1 custom-scrollbar">

            @for(alert of shopAlerts(); track $index) {
              <div class="group flex items-center gap-3 p-2.5 rounded-lg border border-slate-100 bg-white hover:border-slate-200 hover:shadow-sm transition-all cursor-pointer">
                <div class="shrink-0 w-8 h-8 rounded-full flex items-center justify-center"
                     [ngClass]="{
                    'bg-red-50 text-red-500': alert.severity === 'high',
                    'bg-yellow-50 text-yellow-500': alert.severity === 'medium',
                    'bg-cyan-50 text-cyan-500': alert.severity === 'info'
                 }">
                  <i [class]="alert.icon"></i>
                </div>

                <div class="flex-grow min-w-0">
                  <p class="text-xs font-bold text-slate-700 truncate">{{ alert.shopName }}</p>
                  <p class="text-[10px] text-slate-500 truncate">{{ alert.message }}</p>
                </div>

                <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                  <i class="pi pi-chevron-right text-xs text-slate-300"></i>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm flex flex-col">

      <div class="p-4 border-b border-slate-200 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
        <h3 class="text-xl font-bold text-slate-800">Todas las tiendas</h3>
        <div class="flex gap-2 w-full sm:w-auto">
          <p-inputgroup>
            <input pInputText placeholder="Buscar..." />
            <p-inputgroup-addon>
              <p-button icon="pi pi-search" severity="secondary" variant="text"/>
            </p-inputgroup-addon>
          </p-inputgroup>
        </div>
      </div>

      <p-table #dt
               [value]="shopsPage.items"
               [rows]="rows"
               styleClass="p-datatable-sm"
               responsiveLayout="scroll">

        <ng-template pTemplate="header">
          <tr class="bg-slate-50 text-slate-700 text-sm uppercase tracking-wider border-b border-slate-200">
            <th class="font-semibold">C贸digo de referencia</th>
            <th class="font-semibold">Gerente</th>
            <th class="font-semibold">Tienda</th>
            <th class="font-semibold">Direcci贸n</th>
            <th class="font-semibold">Productos totales</th>
            <th class="font-semibold">Camiones asignados</th>
            <th class="font-semibold">Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-shop>
          <tr [pSelectableRow]="shop" class="hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0 group">
            <td class="pl-4 font-mono text-sm text-slate-500">{{ shop.referenceCode }}</td>

            <td>
              @if (shop.assignedManager) {
                <div class="flex items-center gap-2">
                  <p-avatar [image]="shop.assignedManager.imageInfo.imageUrl" shape="circle" />
                  <div>{{ shop.assignedManager.name }}</div>
                </div>
              } @else {
                <div class="text-surface-500 italic text-sm">
                  No asignado
                </div>
              }
            </td>

            <td class="font-bold text-slate-800 text-sm py-3">
              {{ shop.name }}
            </td>

            <td class="text-sm text-slate-600">
              <i class="pi pi-map-marker text-slate-300 mr-1 md:hidden"></i>{{ formatAddress(shop.address) }}
            </td>

            <td class="text-center">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-50 text-green-700 border border-green-100">
                            {{ shop.totalAvailableProducts }} productos
                        </span>
            </td>

            <td class="text-center">
              <div class="flex items-center justify-start gap-1">
                <i class="pi pi-truck text-slate-400 text-xs"></i>
                <span class="text-sm font-bold text-slate-700">{{ shop.totalAssignedTrucks }}</span>
              </div>
            </td>

            <td class="text-right pr-4">
              <div class="flex justify-start gap-2">
                <p-dialog header="Asignar Gerente" [modal]="true" [(visible)]="visibleAssignmentDialog" emptyMessage="No hay gerentes disponibles">
                  <span class="p-text-secondary block mb-4">Proporciona acceso de una cuenta de gerente a la gesti贸n de esta tienda.</span>
                  <p-select [options]="managers" [(ngModel)]="selectedManager" optionLabel="name" placeholder="Selecciona una cuenta..." class="w-full mb-4">
                    <ng-template #empty>
                      <div class="flex items-center gap-2 px-2 py-1 text-surface-500">
                        <span>No existen gerentes disponibles.</span>
                      </div>
                    </ng-template>
                    <ng-template let-user #selectedItem>
                      <div class="flex items-center gap-2">
                        <p-avatar [image]="user.imageInfo.imageUrl" shape="circle" />
                        <div>{{ user.name }}</div>
                      </div>
                    </ng-template>
                    <ng-template let-user #item>
                      <div class="flex items-center gap-2">
                        <p-avatar [image]="user.imageInfo.imageUrl" shape="circle" />
                        <div>{{ user.name }}</div>
                      </div>
                    </ng-template>
                  </p-select>
                  <div class="flex justify-end gap-2">
                    <p-button label="Cancelar" severity="secondary" (click)="cancelAssignment()" />
                    <div *ngIf="visibleUnassignButton">
                      <p-button label="Desasignar" severity="secondary" (click)="setManagerAssignment(shop.id, '0', false)" />
                    </div>
                    <p-button label="Guardar" (click)="setManagerAssignment(shop.id, selectedManager?.id, true)" />
                  </div>
                </p-dialog>

                <p-button icon="pi pi-link" (click)="showAssignmentDialog(shop.id)" styleClass="p-button-xs p-button-outlined p-button-help" rounded="true" pTooltip="Asignar Gerente"></p-button>
                <p-button icon="pi pi-map-marker" (click)="locateShopOnMap(shop); $event.stopPropagation()" styleClass="p-button-xs p-button-outlined p-button-info" rounded="true" pTooltip="Ver en Mapa"></p-button>
                <p-button icon="pi pi-pencil" [routerLink]="['/admin/shops/edit', shop.id]" styleClass="p-button-xs p-button-outlined p-button-warning" rounded="true" pTooltip="Editar Tienda"></p-button>
                <p-button icon="pi pi-trash" (click)="deleteShop(shop.id)" pTooltip="Eliminar Tienda" styleClass="p-button-xs p-button-outlined p-button-danger" rounded="true"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="p-0 border-0">
              <div class="flex flex-col items-center justify-center w-full h-32 text-slate-400 bg-slate-50">
                <i class="pi pi-inbox text-4xl mb-2 text-slate-300"></i>
                <span class="font-medium">No hay tiendas disponibles.</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <p-paginator (onPageChange)="onPageChange($event)" [rows]="rows" [totalRecords]="shopsPage.totalItems" [dropdownAppendTo]="'body'" styleClass="border-t border-slate-200 bg-slate-50 text-sm rounded-b-2xl"></p-paginator>
    </div>

  </div>
</div>
