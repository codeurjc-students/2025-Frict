<app-navbar></app-navbar>

<div *ngIf="loading || error">
  <app-loading-screen [loading]="loading" [error]="error"></app-loading-screen>
</div>

<div *ngIf="!loading && !error" class="bg-surface-50 text-surface-900">
  <!-- MAIN CONTENT -->
  <div class="max-w-[95%] xl:max-w-[83%] mx-auto p-4 py-8">

    <div class="flex flex-wrap gap-3 justify-between items-end mb-6">
      <div>
        <h1 class="text-3xl font-bold text-surface-900 tracking-tight">
          Carrito de compra
        </h1>
        <p class="text-surface-500 mt-1 font-medium">{{ foundItems.totalItems }} productos añadidos</p>
      </div>
    </div>

      <!-- MAIN LAYOUT -->
    <section class="grid grid-cols-1 xl:grid-cols-3 gap-6">

      <!-- LEFT COLUMN -->
      <div class="lg:col-span-2 space-y-8">

        <!-- SECTION 1: CART PRODUCTS -->
        <div class="space-y-4">
          <!-- Empty State -->
          <div *ngIf="foundItems.totalItems === 0" class="bg-white p-12 rounded-2xl border border-surface-200 text-center shadow-sm">
            <div class="w-20 h-20 bg-surface-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-surface-100">
              <i class="pi pi-shopping-cart text-4xl text-surface-300" style="font-size: 2rem"></i>
            </div>
            <h2 class="text-xl font-bold text-surface-900 mb-2">Tu carrito está vacío</h2>
            <p class="text-surface-500 mb-6">Parece que aún no has añadido nada.</p>
          </div>

          <!-- Cart Items List -->
          <div *ngIf="foundItems.totalItems > 0" class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-surface-200">
            <div class="flex justify-end w-full mb-6">
              <button (click)="clearCart()"
                      *ngIf="foundItems.totalItems > 0"
                      class="text-sm text-red-500 hover:text-red-700 font-medium hover:underline decoration-dotted transition-colors">
                Vaciar cesta
              </button>
            </div>

            <div *ngFor="let item of foundItems.orderItems" class="bg-primary-50/50 p-4 mb-4 sm:p-6 rounded-2xl shadow-sm border border-surface-200 group transition-all hover:shadow-md hover:border-surface-300">
              <div class="flex flex-col sm:flex-row gap-6 sm:h-48">

                <!-- Product image -->
                <div class="flex-shrink-0 bg-white border border-surface-100 rounded-xl flex items-center justify-center overflow-hidden relative h-full p-0">
                  <img [src]="item.product.imageUrls[0]" [alt]="item.product.name" class="object-contain w-full h-full max-w-50 max-h-50 mix-blend-multiply" />
                </div>

                <!-- Details -->
                <div class="flex-1 flex flex-col justify-between">
                  <div>
                    <div class="flex justify-between items-start gap-4">
                      <h3 [routerLink]="['/product', item.product.id]" class="text-lg font-bold text-surface-900 leading-tight hover:text-primary-600 cursor-pointer transition-colors">
                        {{ item.product.name }}
                      </h3>
                      <button (click)="removeItem(item.id)" class="text-surface-400 hover:text-red-600 transition-colors p-1 sm:hidden">
                        <i class="pi pi-trash"></i>
                      </button>
                    </div>

                    <p class="text-sm text-surface-500 mt-1">{{ formatCategories(item.product.categories) }}</p>

                    <div *ngIf="item.maxQuantity > 0" class="mt-2">
                      <p-tag icon="pi pi-check" severity="success" [value]="item.maxQuantity + ' disponibles'" />
                    </div>
                    <div *ngIf="!(item.maxQuantity > 0)" class="mt-2">
                      <p-tag icon="pi pi-times" severity="danger" value="No disponible" />
                    </div>
                  </div>

                  <!-- Quantity selection and Price Info -->
                  <div class="flex flex-wrap items-end justify-between gap-4 mt-4">
                    <div class="flex items-center gap-4">
                      <div class="flex items-center border border-surface-300 rounded-lg bg-surface-50 hover:border-surface-400 transition-colors">
                        <p-inputnumber [(ngModel)]="item.quantity" (ngModelChange)="updateItemQuantity(item, $event)" [showButtons]="true" [min]="1" [max]="item.maxQuantity" buttonLayout="horizontal" inputId="horizontal" [inputStyle]="{ width: '3.5rem', height: '2rem' }">
                          <ng-template #incrementbuttonicon>
                            <span class="pi pi-plus" style="font-size: 0.75rem"></span>
                          </ng-template>
                          <ng-template #decrementbuttonicon>
                            <span class="pi pi-minus" style="font-size: 0.75rem"></span>
                          </ng-template>
                        </p-inputnumber>
                      </div>

                      <button (click)="removeItem(item.id)" class="hidden sm:flex text-sm text-surface-400 hover:text-red-600 items-center gap-1 transition-colors font-medium">
                        <i class="pi pi-trash"></i> Eliminar
                      </button>
                    </div>

                    <div class="text-right flex flex-row items-end justify-end gap-2 md:flex-col md:items-end">
                      <span *ngIf="item.product.previousPrice > item.product.currentPrice" class="bg-red-600 text-white text-xs font-bold px-1.5 py-0.5 rounded shadow-sm">
                        {{ item.product.discount }}
                      </span>
                      <div *ngIf="item.product.previousPrice > item.product.currentPrice" class="text-sm text-surface-400 line-through font-medium">
                        {{ formatPrice(item.product.previousPrice) }}
                      </div>
                      <div class="text-2xl font-bold text-surface-900">
                        {{ formatPrice(item.product.currentPrice) }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Order items paginator -->
            <div class="flex items-center justify-end mt-10">
              <span class="mx-2 text-color">Productos por página: </span>
              <p-select [options]="options" optionLabel="label" optionValue="value" [(ngModel)]="itemsRows" (ngModelChange)="firstItem = 0" />
              <p-paginator [first]="firstItem" [rows]="itemsRows" [totalRecords]="foundItems.totalItems" (onPageChange)="onCartItemsPageChange($event)" [showCurrentPageReport]="true"
                           currentPageReportTemplate="{first} - {last} de {totalRecords}" [showPageLinks]="false" [showFirstLastIcon]="false" ></p-paginator>
            </div>
          </div>


        </div>

        <!-- SECTION 2: FAVOURITES (Saved for later) -->
        <div class="pt-6 border-t border-surface-200">
          <div class="flex items-center gap-3 mb-4">
            <div class="bg-primary-100 p-2 rounded-lg text-primary-700">
              <i class="pi pi-reply"></i>
            </div>
            <h2 class="text-xl font-bold text-surface-900">Guardado para más tarde <span class="text-surface-400 text-base font-normal">({{foundProducts.totalProducts}} productos)</span></h2>
          </div>

          <!-- Empty State -->
          <div *ngIf="foundProducts.totalProducts === 0" class="bg-white p-12 rounded-2xl border border-surface-200 text-center shadow-sm">
            <div class="w-20 h-20 bg-surface-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-surface-100">
              <i class="pi pi-star text-4xl text-surface-300" style="font-size: 2rem"></i>
            </div>
            <h2 class="text-xl font-bold text-surface-900 mb-2">No tienes productos favoritos</h2>
            <p class="text-surface-500 mb-6">Los productos que añadas se mostrarán aquí.</p>
          </div>



          <div *ngIf="foundProducts.totalProducts > 0" class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-surface-200">
            <div *ngFor="let product of foundProducts.products" class="bg-white p-4 mb-4 rounded-xl border border-surface-200 flex flex-col sm:flex-row gap-4 hover:border-surface-300 transition-colors">

              <div class="sm:w-32 flex-shrink-0 bg-white border border-surface-100 rounded-xl flex items-center justify-center overflow-hidden relative h-full p-0">
                <img [src]="product.imageUrls[0]" [alt]="product.name" class="object-contain w-full h-full max-w-40 max-h-40" />
              </div>

              <div class="flex-1 flex flex-col justify-between">
                <div class="space-y-1">
                  <h3 [routerLink]="['/product', product.id]" class="font-bold text-surface-900 hover:text-primary-600 cursor-pointer transition-colors">{{ product.name }}</h3>
                  <p class="text-xs text-surface-500 line-clamp-1">{{ formatCategories(product.categories) }}</p>
                  <div class="mt-2">
                    <div *ngIf="product.availableUnits > 0" class="mt-2">
                      <p-tag icon="pi pi-check" severity="success" [value]="product.availableUnits + ' disponibles'" />
                    </div>
                    <div *ngIf="!(product.availableUnits > 0)" class="mt-2">
                      <p-tag icon="pi pi-times" severity="danger" value="No disponible" />
                    </div>
                  </div>
                </div>

                <div class="flex items-end justify-between mt-3">
                  <div class="flex gap-3 text-sm font-medium">
                    <button (click)="moveToCart(product.id)" class="text-primary-600 hover:text-primary-700 hover:underline flex items-center gap-1">
                      <i class="pi pi-cart-plus"></i> Mover al carrito
                    </button>
                    <span class="text-surface-300">|</span>
                    <button (click)="removeFavorite(product.id)" class="text-surface-400 hover:text-red-500 transition-colors">
                      Eliminar
                    </button>
                  </div>
                  <div class="text-lg font-bold text-surface-900">
                    {{ formatPrice(product.currentPrice) }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Favourite products paginator -->
            <div class="flex items-center justify-end mt-10">
              <span class="mx-2 text-color">Productos por página: </span>
              <p-select [options]="options" optionLabel="label" optionValue="value" [(ngModel)]="productsRows" (ngModelChange)="firstProduct = 0" />
              <p-paginator [first]="firstProduct" [rows]="productsRows" [totalRecords]="foundProducts.totalProducts" (onPageChange)="onFavouriteProductsPageChange($event)" [showCurrentPageReport]="true"
                           currentPageReportTemplate="{first} - {last} de {totalRecords}" [showPageLinks]="false" [showFirstLastIcon]="false" ></p-paginator>
            </div>

          </div>
        </div>

      </div>

      <!-- Right column (Summary) -->
      <aside class="xl:col-span-1 h-fit xl:sticky xl:top-24 space-y-4">

        <!-- Summary card -->
        <div class="bg-white p-6 rounded-2xl shadow-md border border-surface-200 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-primary-400 to-orange-400"></div>

          <h2 class="text-xl font-bold text-surface-900 mb-6">Resumen del pedido</h2>

          <div class="space-y-3 text-sm mb-6 font-medium">
            <div class="flex justify-between text-surface-600">
              <span>Subtotal ({{ cartSummary.totalItems }} artículos)</span>
              <span>{{ formatPrice(cartSummary.subtotalCost) }}</span>
            </div>
            <div *ngIf="cartSummary.totalDiscount > 0" class="flex justify-between text-surface-600">
              <span>Descuentos aplicados</span>
              <span class="text-green-600">-{{ formatPrice(cartSummary.totalDiscount) }}</span>
            </div>
            <div *ngIf="cartSummary.totalItems > 0" class="flex justify-between text-surface-600 items-center">
              <span>Envío</span>
              <span *ngIf="cartSummary.totalCost >= 50" class="text-green-700 font-bold text-xs bg-green-100 border border-green-200 px-2 py-1 rounded">GRATIS</span>
              <span *ngIf="cartSummary.totalCost < 50" class="text-yellow-700 font-bold text-xs bg-yellow-100 border border-yellow-200 px-2 py-1 rounded">5,00€</span>
            </div>
          </div>

          <div class="border-t border-surface-200 my-4"></div>

          <div class="flex justify-between items-start mb-6">
            <span class="text-lg font-bold text-surface-900">Total</span>
            <div class="text-right">
              <span class="text-3xl font-bold text-surface-900 block leading-none">{{ formatPrice(cartSummary.totalCost) }}</span>
              <span class="text-xs text-surface-500 font-medium">IVA incluido</span>
            </div>
          </div>

          <div class="flex flex-col gap-3">
            <p-button label="Tramitar pedido" [disabled]="foundItems.totalItems == 0" [raised]="true" routerLink="/summary" styleClass="w-full"/>
            <p-button label="Seguir comprando" [raised]="true" severity="secondary" routerLink="/" styleClass="w-full"/>
          </div>
        </div>

        <div class="space-y-3 text-surface-500 text-sm">
          <div class="flex items-center gap-2 bg-white p-3 rounded-lg border border-surface-200 shadow-sm">
            <i class="pi pi-lock text-primary-500 text-lg"></i> <span class="font-medium">Pago 100% seguro</span>
          </div>
          <div class="flex items-center gap-2 bg-white p-3 rounded-lg border border-surface-200 shadow-sm">
            <i class="pi pi-undo text-primary-500 text-lg"></i> <span class="font-medium">Devoluciones gratis</span>
          </div>
          <div class="flex items-center gap-2 bg-white p-3 rounded-lg border border-surface-200 shadow-sm">
            <i class="pi pi-shield text-primary-500 text-lg"></i> <span class="font-medium">Garantía oficial</span>
          </div>
        </div>

      </aside>
    </section>
  </div>
</div>

<app-footer></app-footer>
