
<div *ngIf="loading || error">
  <app-loading-screen [loading]="loading" [error]="error"></app-loading-screen>
</div>

<div *ngIf="!loading && !error" class="max-w-[95%] xl:max-w-[83%] mx-auto pb-16 relative">

  <div class="py-8 flex flex-col md:flex-row md:items-end justify-between gap-4 mb-4 border-b border-surface-200/60">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold text-surface-900 tracking-tight mb-2">
        Tu Carrito
      </h1>
      <p class="text-surface-500 font-medium flex items-center gap-2">
        <span class="bg-primary-50 text-primary-700 px-2 py-0.5 rounded-md text-sm font-bold border border-primary-100">{{ foundItems.totalItems }}</span>
        productos
      </p>
    </div>

    <button (click)="clearCart()" *ngIf="foundItems.totalItems > 0"
            class="text-sm text-surface-400 hover:text-red-600 font-medium flex items-center gap-2 transition-colors px-3 py-2 rounded-lg hover:bg-red-50">
      <i class="pi pi-trash"></i> Vaciar todo
    </button>
  </div>

  <section class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">

    <div class="lg:col-span-8 space-y-12">

      <div class="space-y-4">

        <div *ngIf="foundItems.totalItems === 0" class="bg-white rounded-3xl p-12 text-center border border-surface-200 shadow-sm">
          <div class="w-24 h-24 bg-surface-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
            <i class="pi pi-shopping-cart text-4xl text-surface-300"></i>
          </div>
          <h2 class="text-2xl font-bold text-surface-900 mb-2">Tu carrito está vacío</h2>
          <p class="text-surface-500 mb-8 max-w-md mx-auto">Parece que aún no has encontrado lo que buscas. ¡Explora nuestro catálogo!</p>
          <p-button label="Empezar a comprar" icon="pi pi-arrow-right" iconPos="right" routerLink="/" styleClass="rounded-xl font-bold px-6"></p-button>
        </div>

        <div *ngIf="foundItems.totalItems > 0" class="flex flex-col gap-4">

          <div *ngFor="let item of foundItems.orderItems"
               class="group bg-white p-4 sm:p-5 rounded-2xl border border-surface-200 shadow-sm hover:shadow-md hover:border-primary-200 transition-all duration-300 relative overflow-hidden">

            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-primary-50/30 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>

            <div class="flex flex-col sm:flex-row gap-5 relative z-10">

              <div class="w-full sm:w-32 h-32 bg-surface-50 rounded-xl border border-surface-100 flex items-center justify-center p-2 shrink-0">
                <img [src]="item.product.imageUrls[0]" [alt]="item.product.name" class="w-full h-full object-contain mix-blend-multiply" />
              </div>

              <div class="flex-1 flex flex-col justify-between min-h-[128px]">

                <div class="flex justify-between items-start gap-4">
                  <div class="space-y-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span *ngIf="item.product.previousPrice > item.product.currentPrice" class="bg-red-100 text-red-700 text-[10px] font-bold px-1.5 py-0.5 rounded border border-red-200 uppercase tracking-wide">Oferta</span>
                      <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest">Ref: {{item.product.referenceCode || 'N/A'}}</span>
                    </div>
                    <h3 [routerLink]="['/product', item.product.id]" class="text-lg font-bold text-surface-900 leading-tight hover:text-primary-600 cursor-pointer transition-colors line-clamp-2">
                      {{ item.product.name }}
                    </h3>
                    <div class="flex items-center gap-2 mt-1">
                      <div *ngIf="item.maxQuantity > 0" class="flex items-center gap-1.5 text-xs font-medium text-green-600 bg-green-50 px-2 py-0.5 rounded-md">
                        <i class="pi pi-check-circle text-[10px]"></i> Disponible
                      </div>
                      <div *ngIf="!(item.maxQuantity > 0)" class="flex items-center gap-1.5 text-xs font-medium text-red-600 bg-red-50 px-2 py-0.5 rounded-md">
                        <i class="pi pi-times-circle text-[10px]"></i> Agotado
                      </div>
                    </div>
                  </div>

                  <button (click)="removeItem(item.id)" class="hidden sm:flex text-surface-400 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-lg" pTooltip="Eliminar producto" tooltipPosition="left">
                    <i class="pi pi-trash"></i>
                  </button>
                </div>

                <div class="flex flex-wrap items-end justify-between gap-4 mt-4 pt-4 border-t border-surface-50">

                  <div class="flex items-center gap-3">
                    <div class="bg-surface-50 p-1 rounded-lg border border-surface-200 flex items-center">
                      <button (click)="updateItemQuantity(item, item.quantity - 1)" [disabled]="item.quantity <= 1" class="w-8 h-8 flex items-center justify-center text-surface-500 hover:text-primary-600 hover:bg-white rounded-md transition-all disabled:opacity-30">
                        <i class="pi pi-minus text-xs"></i>
                      </button>
                      <span class="w-8 text-center font-bold text-surface-900 text-sm">{{ item.quantity }}</span>
                      <button (click)="updateItemQuantity(item, item.quantity + 1)" [disabled]="item.quantity >= item.maxQuantity" class="w-8 h-8 flex items-center justify-center text-surface-500 hover:text-primary-600 hover:bg-white rounded-md transition-all disabled:opacity-30">
                        <i class="pi pi-plus text-xs"></i>
                      </button>
                    </div>
                    <button (click)="removeItem(item.id)" class="sm:hidden text-surface-400 hover:text-red-500 p-2">
                      <i class="pi pi-trash"></i>
                    </button>
                  </div>

                  <div class="text-right">
                    <div *ngIf="item.product.previousPrice > item.product.currentPrice" class="text-xs text-surface-400 line-through font-medium mb-0.5">
                      ({{ formatPrice(item.product.previousPrice) }}/ud)
                    </div>
                    <div class="text-xl font-bold text-surface-900 flex items-center gap-1">
                      {{ formatPrice(item.product.currentPrice * item.quantity) }}
                      <span class="text-xs font-normal text-surface-500" *ngIf="item.quantity > 1">({{ formatPrice(item.product.currentPrice) }}/ud)</span>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div class="flex justify-center mt-6">
            <p-paginator [first]="firstItem" [rows]="itemsRows" [totalRecords]="foundItems.totalItems" (onPageChange)="onCartItemsPageChange($event)"
                         styleClass="!bg-transparent !border-none" [rowsPerPageOptions]="[5, 10, 20]"></p-paginator>
          </div>

        </div>
      </div>

      <div class="pt-8 border-t border-surface-200">
        <div class="flex items-center gap-3 mb-6">
          <h2 class="text-xl font-bold text-surface-900 flex items-center gap-2">
            <i class="pi pi-bookmark text-primary-500"></i> Productos favoritos
            <span class="text-surface-400 font-normal text-base ml-1">({{foundProducts.totalProducts}})</span>
          </h2>
        </div>

        <div *ngIf="foundProducts.totalProducts === 0" class="bg-surface-50 rounded-2xl p-8 text-center border border-dashed border-surface-300">
          <p class="text-surface-500 text-sm font-medium">No tienes productos guardados aún.</p>
        </div>

        <div *ngIf="foundProducts.totalProducts > 0" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div *ngFor="let product of foundProducts.products" class="bg-white p-4 rounded-xl border border-surface-200 flex gap-4 hover:border-surface-300 transition-all group">
            <div class="w-20 h-20 bg-surface-50 rounded-lg border border-surface-100 flex items-center justify-center shrink-0 p-1">
              <img [src]="product.imageUrls[0]" [alt]="product.name" class="w-full h-full object-contain mix-blend-multiply" />
            </div>
            <div class="flex-1 flex flex-col justify-between">
              <div>
                <h3 [routerLink]="['/product', product.id]" class="text-sm font-bold text-surface-900 line-clamp-2 hover:text-primary-600 cursor-pointer mb-2">{{ product.name }}</h3>
                <div class="flex items-center justify-start gap-3">
                  <div class="text-lg font-bold text-surface-900">{{ formatPrice(product.currentPrice) }}</div>
                  <ng-container>
                    <div *ngIf="product.availableUnits > 0" class="flex items-center gap-1.5 text-xs font-medium text-green-600 bg-green-50 px-2 py-0.5 rounded-md border border-green-100 shrink-0">
                      <i class="pi pi-check-circle text-[10px]"></i> Disponible
                    </div>

                    <div *ngIf="!(product.availableUnits > 0)" class="flex items-center gap-1.5 text-xs font-medium text-red-600 bg-red-50 px-2 py-0.5 rounded-md border border-red-100 shrink-0">
                      <i class="pi pi-times-circle text-[10px]"></i> Agotado
                    </div>
                  </ng-container>
                </div>
              </div>

              <div class="flex items-center justify-between mt-2 pt-2 border-t border-surface-50">
                <button (click)="moveToCart(product.id)" [disabled]="isProductInCart(product.id) || product.availableUnits == 0" class="text-xs font-bold text-primary-600 hover:text-primary-700 flex items-center gap-1 bg-primary-50 px-2 py-1 rounded hover:bg-primary-100 transition-colors disabled:bg-surface-100 disabled:text-surface-400">
                  <i class="pi pi-cart-plus"></i> Mover al carro
                </button>
                <button (click)="removeFavorite(product.id)" class="text-surface-400 hover:text-red-500 transition-colors p-1" pTooltip="Eliminar" tooltipPosition="top">
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-center mt-6" *ngIf="foundProducts.totalProducts > 0">
          <p-paginator [first]="firstProduct" [rows]="productsRows" [totalRecords]="foundProducts.totalProducts" (onPageChange)="onFavouriteProductsPageChange($event)"
                       styleClass="!bg-transparent !border-none" [rowsPerPageOptions]="[5, 10, 20]"></p-paginator>
        </div>

      </div>

    </div>

    <aside class="lg:col-span-4 h-fit lg:sticky lg:top-24 space-y-6">

      <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-surface-200 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-primary-400 to-primary-600"></div>

        <h2 class="text-xl font-bold text-surface-900 mb-6">Resumen del pedido</h2>

        <div class="space-y-3 text-sm mb-6 font-medium">
          <div class="flex justify-between text-surface-600">
            <span>Subtotal ({{ cartSummary.totalItems }} artículos)</span>
            <span class="font-bold text-surface-900">{{ formatPrice(cartSummary.subtotalCost) }}</span>
          </div>
          <div *ngIf="cartSummary.totalDiscount > 0" class="flex justify-between text-green-700 bg-green-50 px-2 py-1 rounded-lg">
            <span>Descuentos aplicados</span>
            <span class="font-bold">-{{ formatPrice(cartSummary.totalDiscount) }}</span>
          </div>
          <div *ngIf="cartSummary.totalItems > 0" class="flex justify-between text-surface-600 items-center">
            <span>Envío estimado</span>
            <span *ngIf="cartSummary.totalCost >= 50" class="text-green-700 font-bold text-xs bg-green-100 border border-green-200 px-2 py-1 rounded">GRATIS</span>
            <span *ngIf="cartSummary.totalCost < 50" class="text-surface-900 font-bold">5,00€</span>
          </div>
        </div>

        <div class="border-t border-surface-200 my-4 border-dashed"></div>

        <div class="flex justify-between items-end mb-8">
          <span class="text-lg font-bold text-surface-900 pb-1">Total</span>
          <div class="text-right">
            <span class="text-4xl font-extrabold text-surface-900 block leading-none tracking-tight">{{ formatPrice(cartSummary.totalCost) }}</span>
            <span class="text-[10px] text-surface-500 font-medium uppercase tracking-wider">IVA incluido</span>
          </div>
        </div>

        <div class="flex flex-col gap-3">
          <p-button label="Tramitar pedido" [disabled]="foundItems.totalItems == 0" icon="pi pi-check" iconPos="right"
                    routerLink="/summary" styleClass="w-full !rounded-xl !font-bold !py-3 !text-lg shadow-lg shadow-primary-500/20"></p-button>
          <p-button label="Seguir comprando" severity="secondary" routerLink="/" styleClass="w-full !rounded-xl !font-bold !bg-surface-100 !border-surface-200 !text-surface-700 hover:!bg-surface-200"></p-button>
        </div>

        <div class="flex justify-center gap-4 text-surface-300 text-2xl mt-6 pt-6 border-t border-surface-100">
          <i class="pi pi-credit-card"></i>
          <i class="pi pi-paypal"></i>
          <i class="pi pi-google"></i>
          <i class="pi pi-apple"></i>
        </div>

      </div>

      <div class="space-y-3">
        <div class="flex items-center gap-3 bg-white p-4 rounded-2xl border border-surface-200 shadow-sm text-sm text-surface-600">
          <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shrink-0"><i class="pi pi-lock"></i></div>
          <div>
            <span class="font-bold block text-surface-900">Pago Seguro</span>
            <span class="text-xs">Encriptación SSL 256-bit</span>
          </div>
        </div>
        <div class="flex items-center gap-3 bg-white p-4 rounded-2xl border border-surface-200 shadow-sm text-sm text-surface-600">
          <div class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center shrink-0"><i class="pi pi-undo"></i></div>
          <div>
            <span class="font-bold block text-surface-900">Devoluciones</span>
            <span class="text-xs">30 días de periodo de prueba</span>
          </div>
        </div>
      </div>

    </aside>

  </section>

</div>
