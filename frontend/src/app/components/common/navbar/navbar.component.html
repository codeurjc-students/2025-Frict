<nav class="sticky top-0 z-[2000] bg-surface-700 h-20 text-white border-b border-surface-700/50">

  <div class="max-w-[95%] xl:max-w-[83%] mx-auto flex items-center justify-between gap-2 px-4 h-full">

    <div *ngIf="!authService.isLogged() || !authService.isAdmin()">
      <a routerLink="/" class="flex items-center gap-2 font-bold order-2 sm:order-1 h-full hover:opacity-90 transition-opacity">
        <img class="w-8 h-8 m-1 shrink-0 object-contain" ngSrc="/shopLogo.png" alt="logo" height="96" width="96"/>
        <span class="hidden md:inline text-2xl mr-4 tracking-tight">MiTienda</span>
      </a>
    </div>

    <div *ngIf="authService.isAdmin()">
      <a routerLink="/admin" class="flex items-center gap-2 font-bold order-2 sm:order-1 h-full hover:opacity-90 transition-opacity">
        <img class="w-8 h-8 m-1 shrink-0 object-contain" ngSrc="/frictLogo.png" alt="logo" height="96" width="96"/>
        <span class="hidden md:inline text-2xl mr-4 tracking-tight">Frict</span>
      </a>
    </div>

    <p-button (click)="visible = !visible" iconPos="left" styleClass="h-11 !bg-primary-500/90 hover:!bg-primary/70">
      <ng-template pTemplate="content">
        <i class="pi pi-bars text-white"></i>
        <span class="hidden lg:inline ml-2 font-bold text-white">Menú</span>
      </ng-template>
    </p-button>

    <div class="flex-1 relative w-auto order-3 h-full flex items-center mx-2">
      <div class="flex w-full group">
        <p-inputgroup>
          <input pInputText placeholder="Buscar productos…" [(ngModel)]="searchBarInput" class="!bg-surface-800 !text-surface-200"/>
          <p-button (click)="search()">
            <ng-template pTemplate="content">
              <i class="pi pi-search"></i>
              <span class="hidden md:inline ml-2 font-bold">Buscar</span>
            </ng-template>
          </p-button>
        </p-inputgroup>
      </div>
    </div>

    <div class="flex items-center order-4 h-full gap-2">
      <div *ngIf="authService.isLogged()" class="flex items-center gap-2">

        <div *ngIf="authService.isUser()" class="hidden lg:flex shrink-0">
          <p-select
            [options]="scopeOptions()"
            [ngModel]="productService.searchScope()"
            (ngModelChange)="onScopeChange($event)"
            optionLabel="label"
            optionValue="value"
            optionDisabled="disabled"
            styleClass="!bg-surface-800 !border-surface-600 !rounded-lg !h-11 !flex !items-center hover:!border-primary-500 transition-colors"
            panelStyleClass="!bg-surface-800 !border !border-surface-700 !shadow-xl !rounded-lg mt-1 [&_.p-select-option]:!p-0 [&_.p-select-option]:!bg-transparent [&_.p-select-item]:!p-0 [&_.p-select-item]:!bg-transparent"
            class="w-33 shrink-0">

            <ng-template pTemplate="selectedItem" let-selectedOption>
              <div class="flex items-center gap-2 text-surface-200 font-medium">
                <i class="pi text-primary-400" [ngClass]="selectedOption.value === 'GLOBAL' ? 'pi-globe' : 'pi-map-marker'"></i>
                <span>{{ selectedOption.label }}</span>
              </div>
            </ng-template>

            <ng-template pTemplate="item" let-option>
              <div class="flex items-center gap-3 w-full p-3 transition-colors duration-150"
                   [ngClass]="{
           'opacity-50 cursor-not-allowed text-surface-500': option.disabled,
           'bg-surface-700 text-white': productService.searchScope() === option.value && !option.disabled,
           'text-surface-200 hover:bg-surface-700 hover:text-white': productService.searchScope() !== option.value && !option.disabled
         }">

                <i class="pi" [ngClass]="option.value === 'GLOBAL' ? 'pi-globe' : 'pi-map-marker'"></i>
                <span class="font-medium">{{ option.label }}</span>

                <i *ngIf="option.disabled" class="pi pi-lock ml-auto text-xs"></i>
              </div>
            </ng-template>
          </p-select>
        </div>

        <p-button (click)="menu.toggle($event)" iconPos="left" styleClass="h-11 !text-white !bg-transparent !border-none hover:!bg-white/20">
          <ng-template pTemplate="content">
            <i class="pi pi-bell text-xl"></i>
          </ng-template>
        </p-button>
        <p-menu #menu [model]="items" [popup]="true" styleClass="!bg-surface-800 !border-surface-700 !mt-2" appendTo="body"/>

        <div *ngIf="!authService.isAdmin() && !authService.isManager() && !authService.isDriver()">
          <p-button iconPos="left" styleClass="!bg-primary-500/90 hover:!bg-primary/70 border-none h-11 !text-white rounded-lg px-3" routerLink="/cart">
            <ng-template pTemplate="content">
              <i class="pi pi-shopping-cart text-lg"></i>
              <span class="hidden lg:inline ml-2 font-bold">Cesta ({{ orderService.itemsCount() }})</span>
            </ng-template>
          </p-button>
        </div>
      </div>

      <div *ngIf="!authService.isLogged()">
        <p-button iconPos="left" styleClass="!bg-primary-500/90 hover:!bg-primary/70 border-none h-11 !text-white rounded-lg px-3" routerLink="/login">
          <ng-template pTemplate="content">
            <i class="pi pi-sign-in text-lg"></i>
            <span class="hidden lg:inline ml-2 font-bold">Acceder</span>
          </ng-template>
        </p-button>
      </div>
    </div>
  </div>
</nav>

<p-drawer #drawerRef [(visible)]="visible" styleClass="!bg-surface-800 !border-none !w-90">
  <ng-template #headless>
    <div class="mt-22 flex flex-col h-full overflow-y-auto">

      <div *ngIf="authService.isLogged()" class="top-0 w-full">
        <a class="m-4 flex items-center p-4 gap-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors cursor-pointer" routerLink="/profile">
          <p-avatar [image]=loggedUserInfo.imageUrl class="mr-2" size="large" shape="circle" />
          <div class="flex flex-col">
            <span class="font-bold">{{ loggedUserInfo.name }}</span>
            <span class="font-light text-sm">{{ loggedUserInfo.username }}</span>
          </div>
        </a>
        <hr class="mx-8 mb-6 border-t border-0 border-surface-600" />
      </div>

      <div *ngIf="!authService.isLogged()" class="top-0 w-full" >
        <a class="m-4 flex items-center p-4 gap-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors cursor-pointer" routerLink="/login">
          <p-avatar icon="pi pi-user" size="large" styleClass="bg-surface-700 text-white"/>
          <div class="flex flex-col">
            <span class="font-bold">¡Hola! Identifícate</span>
            <span class="font-light text-sm">Regístrate o inicia sesión</span>
          </div>
        </a>
        <hr class="mx-8 mb-4 border-t border-0 border-surface-600" />
      </div>

      <div class="overflow-y-auto w-full">
        <ul class="list-none px-4 pb-4 m-0">

          <li class="lg:hidden mt-2 mb-2 px-4">
            <span class="font-medium uppercase tracking-wider text-surface-200 text-sm">Ámbito de búsqueda</span>
          </li>

          <li class="lg:hidden">
            <a class="flex items-center p-4 rounded-border transition-colors duration-150"
               [ngClass]="productService.searchScope() === 'GLOBAL'
       ? 'border-l-4 border-primary-500 bg-surface-700 text-white cursor-default'
       : 'text-surface-100 hover:bg-surface-700 cursor-pointer'"
               (click)="productService.searchScope() !== 'GLOBAL' ? onScopeChange('GLOBAL') : null">
              <i class="pi pi-globe mr-3 text-lg"></i>
              <span class="font-medium">Catálogo Global</span>
            </a>
          </li>

          <li class="lg:hidden mb-4">
            <a class="flex items-center p-4 rounded-border transition-colors duration-150"
               [ngClass]="{
       'border-l-4 border-primary-500 bg-surface-700 text-white cursor-default': productService.searchScope() === 'LOCAL',
       'text-surface-100 hover:bg-surface-700 cursor-pointer': productService.searchScope() !== 'LOCAL' && authService.hasShopSelected(),
       'text-surface-500 opacity-50 cursor-not-allowed': !authService.hasShopSelected()
     }"
               (click)="authService.hasShopSelected() && productService.searchScope() !== 'LOCAL' ? onScopeChange('LOCAL') : null">
              <i class="pi pi-map-marker mr-3 text-lg"></i>
              <span class="font-medium">Mi Tienda</span>
              <i *ngIf="!authService.hasShopSelected()" class="pi pi-lock ml-auto text-sm text-surface-500"></i>
            </a>
            <hr class="mx-4 mt-2 border-t border-0 border-surface-600" />
          </li>

          <li>
            <a class="flex items-center cursor-pointer p-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors"
               [routerLink]="['/']"
               routerLinkActive="border-l-4 border-primary-500 bg-surface-700 text-white"
               [routerLinkActiveOptions]="routerOptions">
              <i class="pi pi-home mr-3 text-lg"></i>
              <span class="font-medium">Inicio</span>
            </a>
          </li>

          <li>
            <a class="flex items-center cursor-pointer p-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors"
               [routerLink]="['/search']"
               routerLinkActive="border-l-4 border-primary-500 bg-surface-700 text-white"
               [routerLinkActiveOptions]="routerOptions">
              <i class="pi pi-search mr-3 text-lg"></i>
              <span class="font-medium">Buscar</span>
            </a>
          </li>

          <li>
            <div (click)="toggleCategories()"
                 class="p-4 flex items-center justify-between text-surface-200 cursor-pointer hover:text-white transition-colors p-ripple">
              <span class="font-medium uppercase tracking-wider text-sm">Categorías</span>
              <i class="pi pi-chevron-down transition-transform duration-300"
                 [class.rotate-180]="isCategoriesExpanded()">
              </i>
            </div>

            <ul [class.hidden]="!isCategoriesExpanded()" class="list-none p-0 m-0 overflow-hidden block">

              <div *ngIf="!authService.isAdmin() && !authService.isManager() && !authService.isDriver()">
                <ng-container *ngTemplateOutlet="categoryTree; context: { $implicit: categories, level: 0 }"></ng-container>
              </div>

              <div *ngIf="authService.isAdmin() || authService.isManager() || authService.isDriver()">
                @for (item of adminItems; track item.link) {
                  @if (canViewItem(item)) {
                    <li>
                      <a class="flex items-center cursor-pointer p-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors"
                         [routerLink]="item.link"
                         routerLinkActive="border-l-4 border-primary-500 bg-surface-700 text-white">
                        <i [class]="item.icon + ' mr-3'"></i>
                        <span class="font-medium">{{ item.label }}</span>
                      </a>
                    </li>
                  }
                }
              </div>
            </ul>
          </li>
        </ul>

        <div *ngIf="authService.isLogged()">
          <ul class="list-none p-4 m-0 pt-0">
            <li>
              <div (click)="toggleAccount()"
                   class="p-4 flex items-center justify-between text-surface-200 cursor-pointer hover:text-white transition-colors p-ripple">
                <span class="font-medium uppercase tracking-wider text-sm">Cuenta</span>
                <i class="pi pi-chevron-down transition-transform duration-300"
                   [class.rotate-180]="isAccountExpanded()">
                </i>
              </div>

              <ul [class.hidden]="!isAccountExpanded()" class="list-none p-0 m-0 overflow-hidden block">
                <li>
                  <a class="flex items-center cursor-pointer p-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors" routerLink="/profile" routerLinkActive="border-l-4 border-primary-500 bg-surface-700">
                    <i class="pi pi-user mr-3"></i>
                    <span class="font-medium">Perfil</span>
                  </a>
                </li>
                <li>
                  <a class="flex items-center cursor-pointer p-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors" routerLink="/alerts" routerLinkActive="border-l-4 border-primary-500 bg-surface-700">
                    <i class="pi pi-bell mr-3"></i>
                    <span class="font-medium">Alertas</span>
                    <span class="inline-flex items-center justify-center ml-auto bg-primary-400 text-surface-900 rounded-full text-xs font-bold" style="min-width: 1.5rem; height: 1.5rem">3</span>
                  </a>
                </li>
                <li>
                  <a class="flex items-center cursor-pointer p-4 rounded-border hover:bg-surface-700 duration-150 transition-colors text-red-300 hover:text-red-200" (click)="logout()">
                    <i class="pi pi-sign-out mr-3"></i>
                    <span class="font-medium">Cerrar sesión</span>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </ng-template>
</p-drawer>

<ng-template #categoryTree let-items let-level="level">
  @for (cat of items; track cat.id) {
    <li>
      @if (cat.children && cat.children.length > 0) {

        <div class="flex items-stretch justify-between rounded-border overflow-hidden group hover:bg-surface-700 transition-colors">

          <a [routerLink]="['/category', cat.id]"
             routerLinkActive="border-l-4 border-primary-500 bg-surface-700 text-white"
             [routerLinkActiveOptions]="{ exact: false }"
             #rla="routerLinkActive"
             class="flex-1 flex items-center cursor-pointer p-4 text-surface-100 hover:text-primary-400 transition-colors"
             [style.padding-left.rem]="1 + (level * 1.5)">

            <i [class]="(cat.icon || 'pi pi-folder') + ' mr-3 text-lg'"></i>
            <span class="font-medium">{{ cat.name || 'Categoría' }}</span>
          </a>

          @let isOpen = shouldExpand(+cat.id, rla.isActive);

          <div (click)="toggleSubmenu(+cat.id, rla.isActive)"
               [class.bg-surface-700]="rla.isActive"
               [class.text-white]="rla.isActive"
               [class.text-surface-400]="!rla.isActive"
               class="w-14 flex items-center justify-center cursor-pointer hover:text-white hover:bg-surface-600 border-l border-surface-600/50 p-ripple">

            <i class="pi pi-chevron-down transition-transform duration-300"
               [class.rotate-180]="isOpen"></i>
          </div>

        </div>

        <ul [class.hidden]="!isOpen"
            class="list-none p-0 m-0 overflow-hidden block">
          <ng-container *ngTemplateOutlet="categoryTree; context: { $implicit: cat.children, level: level + 1 }"></ng-container>
        </ul>
      }

      @else {
        <a class="flex items-center cursor-pointer p-4 rounded-border text-surface-100 hover:bg-surface-700 duration-150 transition-colors"
           [routerLink]="['/search']"
           [queryParams]="{ categories: cat.id }"
           routerLinkActive="border-l-4 border-primary-500 bg-surface-700 text-white"
           [routerLinkActiveOptions]="routerOptions"
           [style.padding-left.rem]="1 + (level * 1.5)">

          <i [class]="(cat.icon || 'pi pi-tag') + ' mr-3 text-lg'"></i>
          <span class="font-medium">{{ (cat.name || 'Categoría') }}</span>
        </a>
      }
    </li>
  }
</ng-template>
