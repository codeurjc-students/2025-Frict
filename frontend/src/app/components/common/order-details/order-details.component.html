<app-navbar></app-navbar>

<app-loading-screen [loading]="loading" [error]="error" errorText="Cargando información del pedido..."></app-loading-screen>

<div *ngIf="!loading && order" class="max-w-[95%] xl:max-w-[83%] mx-auto pb-12">

  <div class="mt-6 mb-4">
    <a routerLink="/profile" class="inline-flex items-center gap-2 text-surface-500 hover:text-primary-600 transition-colors cursor-pointer font-bold text-sm">
      <i class="pi pi-arrow-left"></i> Volver a mis pedidos
    </a>
  </div>

  <section class="mb-8 relative">
    <div class="bg-surface-900 rounded-[2rem] p-8 md:p-10 shadow-xl overflow-hidden relative border border-surface-700">

      <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-primary-500/10 rounded-full blur-[120px] translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 left-0 w-[300px] h-[300px] bg-cyan-500/10 rounded-full blur-[100px] -translate-x-1/4 translate-y-1/4"></div>

      <div class="relative">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-12">
          <div>
            <div class="flex items-center gap-3 mb-2">
              <span class="text-surface-400 font-medium uppercase tracking-wider text-xs">Referencia</span>
            </div>

            <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-tight">
              {{ order.referenceCode }}
            </h1>

            <div class="mt-4" *ngIf="order.history && order.history.length > 0">
              <p-tag [value]="order.history[order.history.length-1].status" severity="info" [rounded]="true" styleClass="uppercase text-xs font-bold tracking-wider bg-surface-800 border border-surface-700 text-primary-400 px-3 py-1"></p-tag>
            </div>

          </div>

          <div class="flex gap-3">
            <p-button label="Descargar Factura" icon="pi pi-file-pdf" [outlined]="true" severity="secondary" styleClass="!text-white !border-surface-600 hover:!bg-surface-800" />
            <div *ngIf="!(order.history[order.history.length-1].status == 'Completado') && !(order.history[order.history.length-1].status == 'Cancelado')">
              <p-button (click)="cancelOrder()" label="Cancelar pedido" icon="pi pi-times-circle" [outlined]="true" severity="secondary" styleClass="!text-white !border-surface-600 hover:!bg-surface-800" />
            </div>
          </div>
        </div>

        <div class="mt-12 pt-8 border-t border-surface-700/50">
          <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
            <i class="pi pi-list text-primary-400"></i> Historial de seguimiento detallado
          </h3>

          <div class="space-y-0">
            <ng-container *ngFor="let status of order.history; let isLast = last">
              <div *ngIf="order.history && order.history.length > 0" class="flex gap-4 relative pb-8 last:pb-0">

                <div *ngIf="!isLast" class="absolute left-[19px] top-8 bottom-0 w-[2px] bg-surface-800"></div>

                <div class="relative w-10 h-10 rounded-full bg-surface-800 border border-surface-700 flex items-center justify-center shrink-0 text-primary-400 shadow-lg">
                  <i [class]="status.icon" class="text-sm"></i>
                </div>

                <div class="pt-1 w-full">
                  <h4 class="text-white font-bold text-lg mb-3">{{ status.status }}</h4>

                  <div class="flex flex-col gap-3">
                    <div *ngFor="let update of status.updates" class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-4 group">

                      <div class="shrink-0">
                        <span class="text-xs font-mono font-medium text-primary-400 bg-surface-800/80 border border-surface-700 px-2 py-1 rounded-md inline-block min-w-[100px] text-center">
                          {{ update.date }}
                        </span>
                      </div>

                      <p class="text-surface-400 text-sm leading-relaxed pt-0.5 group-hover:text-surface-300 transition-colors">
                        {{ update.description }}
                      </p>
                    </div>
                  </div>

                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm flex flex-col h-full">
      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-map-marker text-lg text-primary-500"></i> Dirección de Envío
        </h3>
        <p class="text-surface-600 leading-relaxed mb-12">
          {{ order.fullSendingAddress }}
        </p>
      </div>

      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-clock text-lg text-primary-500"></i> Fecha de confirmación
        </h3>
        <p class="text-surface-600 leading-relaxed">
          {{ order.createdAt }}
        </p>
      </div>
    </div>

    <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm flex flex-col justify-between h-full">
      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-credit-card text-lg text-primary-500"></i> Pago realizado
        </h3>
        <div class="flex items-center gap-3 mb-2">
          <i class="pi pi-check-circle text-green-500 text-xl"></i>
          <span class="font-bold text-surface-900">Pagado correctamente</span>
        </div>
        <p class="text-surface-600">
          Tarjeta bancaria<br>
          Terminada en <span class="font-bold">•••• {{ order.cardNumberEnding }}</span>
        </p>
      </div>
    </div>

    <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm flex flex-col justify-between h-full relative overflow-hidden">
      <div class="absolute right-0 top-0 w-24 h-24 bg-primary-50 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>

      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-receipt text-lg text-primary-500"></i> Resumen
        </h3>
        <div class="flex justify-between items-center mb-2">
          <span class="text-surface-600">Subtotal ({{ order.totalItems }} artículos):</span>
          <span class="font-medium text-surface-900">{{ formatPrice(order.subtotalCost) }}</span>
        </div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-surface-600">Descuentos aplicados:</span>
          <span class="font-medium text-surface-900">-{{ formatPrice(order.totalDiscount) }}</span>
        </div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-surface-600">Coste de envío:</span>
          <span class="font-medium text-surface-900">{{ formatPrice(order.shippingCost) }}</span>
        </div>
        <p-divider styleClass="my-3"></p-divider>
        <div class="flex justify-between items-center">
          <span class="text-lg font-bold text-surface-900">Total</span>
          <span class="text-2xl font-extrabold text-primary-600">{{ formatPrice(order.totalCost) }}</span>
        </div>
      </div>
    </div>
  </section>

  <section class="bg-white border border-surface-200 rounded-2xl p-6 md:p-8 shadow-sm">
    <h3 class="text-xl font-bold text-surface-900 mb-6">Contenido del Pedido</h3>

    <div class="flex flex-col gap-6">
      <div *ngFor="let item of order.orderItems" class="flex flex-col sm:flex-row items-center gap-6 pb-6 border-b border-surface-100 last:border-0 last:pb-0">

        <div class="w-24 h-24 sm:w-32 sm:h-32 bg-surface-50 rounded-xl flex items-center justify-center p-2 border border-surface-100 shrink-0">
          <img [src]="item.product.imageUrls && item.product.imageUrls.length > 0 ? item.product.imageUrls[0] : 'assets/placeholder.png'"
               [alt]="item.product.name"
               class="w-full h-full object-contain mix-blend-multiply">
        </div>

        <div class="flex-1 text-center sm:text-left w-full">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
            <div>
              <span class="text-xs text-primary-500 font-bold uppercase tracking-wider" *ngIf="item.product.categories && item.product.categories.length > 0">
                {{ item.product.categories[0].name }}
              </span>
              <h4 [routerLink]="['/product', item.product.id]" class="text-lg font-bold text-surface-900 hover:text-primary-600 cursor-pointer transition-colors">
                {{ item.product.name }}
              </h4>
            </div>
            <div class="hidden sm:block text-right">
              <p class="text-lg font-bold text-surface-900">{{ formatPrice(item.itemsCost) }}</p>
              <p class="text-xs text-surface-500" *ngIf="item.quantity > 1">({{ formatPrice(item.itemsCost / item.quantity) }} / ud.)</p>
            </div>
          </div>

          <div class="flex items-center justify-center sm:justify-start gap-4 mt-2">
            <div class="px-3 py-1 bg-surface-100 rounded-lg text-sm font-medium text-surface-700">
              Cantidad: {{ item.quantity }}
            </div>
          </div>

          <div class="sm:hidden mt-4 pt-4 border-t border-surface-100 w-full flex justify-between items-center">
            <span class="text-surface-500 text-sm">Total artículo:</span>
            <span class="font-bold text-surface-900 text-lg">{{ formatPrice(item.itemsCost) }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

</div>

<app-footer></app-footer>
