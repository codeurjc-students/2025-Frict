<app-navbar></app-navbar>

<app-loading-screen [loading]="loading" [error]="error" errorText="Cargando información del pedido..."></app-loading-screen>

<div class="max-w-[95%] xl:max-w-[83%] mx-auto pb-12">

  <div class="mt-6 mb-4">
    <a routerLink="/profile" class="inline-flex items-center gap-2 text-surface-500 hover:text-primary-600 transition-colors cursor-pointer font-bold text-sm">
      <i class="pi pi-arrow-left"></i> Volver a mis pedidos
    </a>
  </div>

  <section class="mb-8 relative">
    <div class="bg-surface-900 rounded-[2rem] p-8 md:p-10 shadow-2xl overflow-hidden relative border border-surface-700">

      <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-primary-500/10 rounded-full blur-[120px] translate-x-1/2 -translate-y-1/2"></div>
      <div class="absolute bottom-0 left-0 w-[300px] h-[300px] bg-cyan-500/10 rounded-full blur-[100px] -translate-x-1/4 translate-y-1/4"></div>

      <div class="relative z-10">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-12">
          <div>
            <div class="flex items-center gap-3 mb-2">
              <span class="text-surface-400 font-medium uppercase tracking-wider text-xs">Referencia</span>
            </div>
            <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-tight">
              {{ order.referenceCode }}
            </h1>
          </div>
          <div class="flex gap-3">
            <p-button label="Descargar Factura" icon="pi pi-file-pdf" [outlined]="true" severity="secondary" styleClass="!text-white !border-surface-600 hover:!bg-surface-800" />
            <p-button label="Ayuda" icon="pi pi-question-circle" [text]="true" styleClass="!text-surface-300 hover:!text-white" />
          </div>
        </div>

        <p-timeline [value]="steps" layout="horizontal" align="top" styleClass="custom-timeline w-full">
          <ng-template pTemplate="marker" let-step>
            <span class="flex w-10 h-10 items-center justify-center rounded-full shadow-lg z-10 transition-colors duration-300"
                  [ngStyle]="{backgroundColor: step.date ? '#0ea5e9' : '#334155', color: step.date ? '#fff' : '#94a3b8'}">
                <i [class]="step.icon + ' text-lg'"></i>
            </span>
          </ng-template>

          <ng-template pTemplate="content" let-step>
            <div class="mt-4 text-center md:text-left">
              <div class="font-bold text-sm md:text-base" [ngClass]="step.date ? 'text-white' : 'text-surface-500'">
                {{ step.status }}
              </div>
              <div *ngIf="step.date" class="text-xs text-primary-400 font-medium mt-1">
                {{ step.date }}
              </div>
              <div *ngIf="!step.date" class="text-xs text-surface-600 mt-1">
                Pendiente
              </div>
            </div>
          </ng-template>

          <ng-template pTemplate="connector" let-step>
            <div class="h-[2px] w-full transition-colors duration-300" [ngStyle]="{backgroundColor: step.completed ? '#0ea5e9' : '#334155'}"></div>
          </ng-template>
        </p-timeline>

        <div class="mt-12 pt-8 border-t border-surface-700/50">
          <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
            <i class="pi pi-list text-primary-400"></i> Historial de seguimiento
          </h3>

          <div class="space-y-0">
            <ng-container *ngFor="let step of steps; let isLast = last">
              <div *ngIf="step.date" class="flex gap-4 relative pb-8 last:pb-0">

                <div *ngIf="!isLast" class="absolute left-[19px] top-8 bottom-0 w-[2px] bg-surface-800"></div>

                <div class="relative z-10 w-10 h-10 rounded-full bg-surface-800 border border-surface-700 flex items-center justify-center shrink-0 text-primary-400 shadow-lg">
                  <i [class]="step.icon" class="text-sm"></i>
                </div>

                <div class="pt-1">
                  <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-3">
                    <h4 class="text-white font-bold">{{ step.status }}</h4>
                    <span class="text-xs text-primary-400 font-mono bg-surface-800/50 px-2 py-0.5 rounded">{{ step.date }}</span>
                  </div>
                  <p class="text-surface-400 text-sm mt-2 leading-relaxed max-w-2xl">
                    {{ step.description }}
                  </p>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm flex flex-col justify-between h-full">
      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-map-marker text-lg text-primary-500"></i> Dirección de Envío
        </h3>
        <p class="text-surface-600 leading-relaxed">
          {{ order.fullSendingAddress }}
        </p>
      </div>

      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-clock text-lg text-primary-500"></i> Fecha de confirmación
        </h3>
        <p class="text-surface-600 leading-relaxed">
          {{ order.createdAt }}
        </p>
      </div>
    </div>

    <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm flex flex-col justify-between h-full">
      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-credit-card text-lg text-primary-500"></i> Pago realizado
        </h3>
        <div class="flex items-center gap-3 mb-2">
          <i class="pi pi-check-circle text-green-500 text-xl"></i>
          <span class="font-bold text-surface-900">Pagado correctamente</span>
        </div>
        <p class="text-surface-600">
          Tarjeta bancaria<br>
          Terminada en <span class="font-bold">•••• {{ order.cardNumberEnding }}</span>
        </p>
      </div>
    </div>

    <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm flex flex-col justify-between h-full relative overflow-hidden">
      <div class="absolute right-0 top-0 w-24 h-24 bg-primary-50 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>

      <div>
        <h3 class="text-surface-500 font-bold text-xs uppercase tracking-wide mb-4 flex items-center gap-2">
          <i class="pi pi-receipt text-lg text-primary-500"></i> Resumen
        </h3>
        <div class="flex justify-between items-center mb-2">
          <span class="text-surface-600">Subtotal:</span>
          <span class="font-medium text-surface-900">{{ formatPrice(order.subtotalCost) }}</span>
        </div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-surface-600">Descuentos aplicados:</span>
          <span class="font-medium text-surface-900">-{{ formatPrice(order.totalDiscount) }}</span>
        </div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-surface-600">Coste de envío:</span>
          <span class="font-medium text-surface-900">{{ formatPrice(order.shippingCost) }}</span>
        </div>
        <p-divider styleClass="my-3"></p-divider>
        <div class="flex justify-between items-center">
          <span class="text-lg font-bold text-surface-900">Total</span>
          <span class="text-2xl font-extrabold text-primary-600">{{ formatPrice(order.totalCost) }}</span>
        </div>
      </div>
    </div>
  </section>

  <section class="bg-white border border-surface-200 rounded-2xl p-6 md:p-8 shadow-sm">
    <h3 class="text-xl font-bold text-surface-900 mb-6">Contenido del Pedido</h3>

    <div class="flex flex-col gap-6">
      <div *ngFor="let item of order.orderItems" class="flex flex-col sm:flex-row items-center gap-6 pb-6 border-b border-surface-100 last:border-0 last:pb-0">

        <div class="w-24 h-24 sm:w-32 sm:h-32 bg-surface-50 rounded-xl flex items-center justify-center p-2 border border-surface-100 shrink-0">
          <img [src]="item.product.imageUrls[0]" [alt]="item.product.name" class="w-full h-full object-contain mix-blend-multiply">
        </div>

        <div class="flex-1 text-center sm:text-left w-full">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
            <div>
              <span class="text-xs text-primary-500 font-bold uppercase tracking-wider">{{ item.product.categories[0].name }}</span>
              <h4 [routerLink]="['/product', item.product.id]" class="text-lg font-bold text-surface-900 hover:text-primary-600 cursor-pointer transition-colors">{{ item.product.name }}</h4>
            </div>
            <div class="hidden sm:block text-right">
              <p class="text-lg font-bold text-surface-900">{{ formatPrice(item.itemsCost) }}</p>
              <p class="text-xs text-surface-500" *ngIf="item.quantity > 1">({{ formatPrice(item.itemsCost / item.quantity) }} / ud.)</p>
            </div>
          </div>

          <div class="flex items-center justify-center sm:justify-start gap-4 mt-2">
            <div class="px-3 py-1 bg-surface-100 rounded-lg text-sm font-medium text-surface-700">
              Cantidad: {{ item.quantity }}
            </div>
            <p-button label="Opinar" icon="pi pi-star" [text]="true" size="small" styleClass="text-amber-500 hover:text-amber-600 px-0"></p-button>
            <div class="w-px h-4 bg-surface-300"></div>
            <p-button label="Comprar de nuevo" icon="pi pi-refresh" [text]="true" size="small" styleClass="text-primary-600 hover:text-primary-700 px-0"></p-button>
          </div>

          <div class="sm:hidden mt-4 pt-4 border-t border-surface-100 w-full flex justify-between items-center">
            <span class="text-surface-500 text-sm">Total artículo:</span>
            <span class="font-bold text-surface-900 text-lg">{{ item.itemsCost }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

</div>

<app-footer></app-footer>
