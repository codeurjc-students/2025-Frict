<app-navbar></app-navbar>

<app-loading-screen [loading]="loading" [error]="error" errorText="Cargando información de perfil..."></app-loading-screen>

<p-toast position="bottom-right"/>

<div *ngIf="!loading && !error" class="max-w-[95%] xl:max-w-[83%] mx-auto pb-12">
  <section class="mt-6 mb-12 relative">
    <div class="bg-surface-900 rounded-[2rem] p-8 md:p-12 shadow-xl overflow-hidden relative flex flex-col md:flex-row items-center gap-8 border border-surface-700">

      <div class="absolute top-0 right-0 w-[400px] h-[400px] bg-primary-500/15 rounded-full blur-[100px] translate-x-1/3 -translate-y-1/3"></div>
      <div class="absolute bottom-0 left-0 w-[300px] h-[300px] bg-cyan-500/15 rounded-full blur-[80px] -translate-x-1/4 translate-y-1/4"></div>

      <div class="relative z-10">
        <div class="p-1 bg-gradient-to-br from-primary-400 to-cyan-400 rounded-full">
          <p-avatar
            [image]="user.imageUrl"
            shape="circle"
            styleClass="!w-30 !h-30 border-4 border-surface-900" />
        </div>
      </div>

      <div class="relative z-10 text-center md:text-left space-y-2">
        <div class="inline-block">
          <p-tag [value]="getRoleLabel(user.roles[0])" severity="info" [rounded]="true" styleClass="uppercase text-xs font-bold tracking-wider bg-surface-800 border border-surface-700 text-primary-400 px-3 py-1"></p-tag>
        </div>
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-tight">
          Hola, <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary-400 to-cyan-400">{{ user.name }}</span>
        </h1>
        <p class="text-surface-400 text-lg font-light">Bienvenido de nuevo a tu panel personal.</p>
      </div>

      <div class="relative z-10 md:ml-auto">
        <p-button
          label="Eliminar cuenta"
          icon="pi pi-times"
          [outlined]="true"
          severity="secondary"
          styleClass="!text-white !border-surface-600 hover:!bg-surface-800 !rounded-full px-6" />
      </div>
    </div>
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <section class="lg:col-span-1 space-y-8">
      <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-surface-900">
            <i class="pi pi-id-card text-primary-500 mr-2"></i>Datos personales</h3>
          <p-button (click)="showDataDialog()" icon="pi pi-pen-to-square" [text]="true" [rounded]="true" size="small" />
        </div>
        <div class="space-y-4">
          <div>
            <label class="text-xs text-surface-500 font-bold uppercase tracking-wide">Nombre Completo</label>
            <p class="text-surface-900 font-medium text-lg">{{ user.name }}</p>
          </div>
          <div>
            <label class="text-xs text-surface-500 font-bold uppercase tracking-wide">Nombre de usuario</label>
            <p class="text-surface-900 font-medium text-lg">{{ user.username }}</p>
          </div>
          <div>
            <label class="text-xs text-surface-500 font-bold uppercase tracking-wide">Email</label>
            <p class="text-surface-900 font-medium text-lg">{{ user.email }}</p>
          </div>
          <div>
            <label class="text-xs text-surface-500 font-bold uppercase tracking-wide">Teléfono</label>
            <p class="text-surface-900 font-medium text-lg">{{ user.phone }}</p>
          </div>
        </div>

        <!-- Edit profile details dialog -->
        <p-dialog maskStyleClass="backdrop-blur-sm" [(visible)]="visibleDataDialog" styleClass="!border-0 !bg-transparent">
          <ng-template #headless>
            <div class="w-200 mt-2 p-6 bg-white border border-surface-200 rounded-xl">
              <h4 class="font-bold mb-4">Editar datos personales:</h4>
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Nombre completo</label>
                  <input pInputText placeholder="Nombre y apellidos" [(ngModel)]="newUserData.name" class="w-full"/>
                </div>
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Nombre de usuario</label>
                  <input pInputText placeholder="Alias" [(ngModel)]="newUserData.username" class="w-full md:col-span-2" />
                </div>
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Correo electrónico</label>
                  <input pInputText placeholder="Dirección de correo" [(ngModel)]="newUserData.email" class="w-full md:col-span-2" />
                </div>
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Teléfono</label>
                  <input pInputText placeholder="Número de teléfono" [(ngModel)]="newUserData.phone" class="w-full md:col-span-2" />
                </div>
              </div>
              <div class="flex justify-end mt-4 gap-2">
                <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="cancelEditData()"></p-button>
                <p-button label="Guardar" styleClass="p-button-primary" (onClick)="saveEditData()"></p-button>
              </div>
            </div>
          </ng-template>
        </p-dialog>
      </div>

      <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-surface-900">Direcciones</h3>
          <p-button (click)="showAddressDialog()" icon="pi pi-plus" [text]="true" [rounded]="true" size="small" />
        </div>
        <div class="space-y-3">
          <div *ngFor="let addr of user.addresses" class="flex items-start gap-3 p-3 bg-surface-50 rounded-xl border border-surface-100 hover:border-primary-200 transition-colors cursor-pointer group">

            <div class="w-8 h-8 rounded-full bg-primary-50 flex items-center justify-center text-primary-500 mt-1 group-hover:bg-primary-500 group-hover:text-white transition-colors">
              <i class="pi pi-map-marker text-sm"></i>
            </div>

            <div>
              <p class="text-sm font-bold text-surface-900">{{ addr.alias }}</p>
              <p class="text-xs text-surface-500 leading-relaxed">
                {{ addr.street }} {{ addr.number }} {{ addr.floor }} <br>
                {{ addr.postalCode }} {{ addr.city }} ({{ addr.country }})
              </p>
            </div>

            <div class="ml-auto flex gap-2 self-center" (click)="$event.stopPropagation()">
              <p-button
                icon="pi pi-pencil"
                [rounded]="true"
                text
                severity="info"
              />

              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                text
                severity="danger"
              />
            </div>

          </div>
        </div>

        <!-- Create / Edit address dialog -->
        <p-dialog maskStyleClass="backdrop-blur-sm" [(visible)]="visibleAddressDialog" styleClass="!border-0 !bg-transparent">
          <ng-template #headless>
            <div class="w-200 mt-2 p-6 bg-white border border-surface-200 rounded-xl">
              <div *ngIf="newAddress.id">
                <h4 class="font-bold mb-4">Editar dirección de envío:</h4>
              </div>
              <div *ngIf="!newAddress.id">
                <h4 class="font-bold mb-4">Nueva dirección de envío:</h4>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Alias</label>
                  <input pInputText placeholder="Nombre preferido..." [(ngModel)]="newAddress.alias" class="w-full"/>
                </div>
                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Calle</label>
                  <input pInputText placeholder="Tipo y nombre de vía..." [(ngModel)]="newAddress.street" class="w-full md:col-span-2" />
                </div>
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Número</label>
                  <input pInputText placeholder="Número de domicilio..." [(ngModel)]="newAddress.number" class="w-full"/>
                </div>
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Piso</label>
                  <input pInputText placeholder="Piso y letra..." [(ngModel)]="newAddress.floor" class="w-full" />
                </div>
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Código postal</label>
                  <input pInputText placeholder="Código postal..." [(ngModel)]="newAddress.postalCode" class="w-full" />
                </div>
                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Ciudad</label>
                  <input pInputText placeholder="Nombre de población..." [(ngModel)]="newAddress.city" class="w-full" />
                </div>
                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-surface-600 mb-1 block">País</label>
                  <input pInputText placeholder="Nombre de país..." [(ngModel)]="newAddress.country" class="w-full"/>
                </div>
              </div>
              <div class="flex justify-end mt-4 gap-2">
                <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="cancelNewAddress()"></p-button>
                <p-button label="Guardar" styleClass="p-button-primary" (onClick)="saveNewAddress()"></p-button>
              </div>
            </div>
          </ng-template>
        </p-dialog>
      </div>

      <div class="bg-white border border-surface-200 rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-surface-900">Métodos de Pago</h3>
          <p-button (click)="showCardDialog()" icon="pi pi-plus" [text]="true" [rounded]="true" size="small" />
        </div>
        <div class="space-y-3">
          <div *ngFor="let card of user.cards" class="flex items-center gap-3 p-3 bg-surface-50 rounded-xl border border-surface-100">

            <div class="w-10 h-10 rounded-full bg-surface-200 flex items-center justify-center text-surface-600">
              <i class="pi pi-credit-card"></i>
            </div>

            <div>
              <p class="text-sm font-bold text-surface-900 capitalize">{{ card.alias }} (••••{{ card.numberEnding }})</p>
              <p class="text-xs text-surface-500">Titular: {{ card.cardOwnerName }}</p>
              <p class="text-xs text-surface-500">Expira: {{ card.dueDate }}</p>
            </div>

            <div class="ml-auto flex gap-2">
              <p-button
                icon="pi pi-pencil"
                [rounded]="true"
                text
                severity="info"
                 />

              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                text
                severity="danger"
                 />
            </div>

          </div>
        </div>

        <!-- Create / Edit card dialog -->
        <p-dialog maskStyleClass="backdrop-blur-sm" [(visible)]="visibleCardDialog" styleClass="!border-0 !bg-transparent">
          <ng-template #headless>
            <div class="w-200 mt-2 p-6 bg-white border border-surface-200 rounded-xl">
              <div *ngIf="newCard.id">
                <h4 class="font-bold mb-4">Editar tarjeta:</h4>
              </div>
              <div *ngIf="!newCard.id">
                <h4 class="font-bold mb-4">Nueva tarjeta:</h4>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Alias de la tarjeta</label>
                  <input pInputText placeholder="Nombre completo" [(ngModel)]="newCard.alias" class="w-full" />
                </div>

                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Número de tarjeta</label>
                  <p-inputmask mask="9999 9999 9999 9999" [(ngModel)]="newCard.number" placeholder="0000 0000 0000 0000" styleClass="w-full" />
                </div>

                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Titular de la tarjeta</label>
                  <input pInputText placeholder="Nombre completo" [(ngModel)]="newCard.cardOwnerName" class="w-full" />
                </div>

                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">Caducidad</label>
                  <p-inputmask mask="99/99" [(ngModel)]="newCard.dueDate" placeholder="MM/AA" styleClass="w-full" />
                </div>

                <div>
                  <label class="text-sm font-medium text-surface-600 mb-1 block">CVV</label>
                  <p-inputmask mask="999" [(ngModel)]="newCard.cvv" placeholder="000" styleClass="w-full" />
                </div>
              </div>

              <div class="flex justify-end mt-6 gap-2">
                <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="cancelNewCard()"></p-button>
                <p-button label="Guardar tarjeta" styleClass="p-button-primary" (onClick)="saveNewCard()"></p-button>
              </div>
            </div>
          </ng-template>
        </p-dialog>
      </div>
    </section>

    <div class="lg:col-span-2 space-y-8">

      <section class="bg-white border border-surface-200 rounded-2xl p-6 md:p-8 shadow-sm">
        <div class="flex justify-between items-end mb-6">
          <div>
            <h2 class="text-2xl font-bold text-surface-900 tracking-tight">Mis Pedidos</h2>
            <p class="text-surface-500 text-sm mt-1">Historial de tus últimas compras</p>
          </div>
        </div>

        <div class="flex flex-col gap-4">
          <div *ngFor="let order of foundOrders.orders" class="group flex flex-col md:flex-row md:items-center justify-between p-4 rounded-xl border border-surface-100 hover:border-primary-300 hover:shadow-md transition-all bg-surface-50/50 hover:bg-white">

            <div class="flex items-center gap-4 mb-4 md:mb-0">
              <div class="w-12 h-12 rounded-full bg-surface-200 flex items-center justify-center text-surface-600 group-hover:bg-primary-50 group-hover:text-primary-600 transition-colors">
                <i class="pi pi-box text-xl"></i>
              </div>
              <div>
                <p class="font-bold text-surface-900 text-lg">{{ order.referenceCode }}</p>
                <div class="flex items-center gap-2 text-xs text-surface-500">
                  <i class="pi pi-calendar"></i> {{ order.createdAt }}
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between md:justify-end gap-6 w-full md:w-auto">
              <div class="text-right mr-4">
                <p class="text-sm font-bold text-surface-900">{{ order.totalCost }}</p>
                <p class="text-xs text-surface-500">Total</p>
              </div>

              <p-tag [value]="order.history[order.history.length-1].status" [severity]="getStatusSeverity(order.history[order.history.length-1].status)" styleClass="min-w-[90px] text-center"></p-tag>

              <p-button
                icon="pi pi-angle-right"
                [routerLink]="['/order', order.id]"
                [rounded]="true"
                [text]="true"
                severity="secondary"
                styleClass="hover:!bg-surface-100" />
            </div>
          </div>
          <div class="flex justify-center mt-6">
            <p-paginator [first]="firstOrder" [rows]="ordersRows" [totalRecords]="foundOrders.totalOrders" (onPageChange)="onUserOrdersPageChange($event)"
                         styleClass="!bg-transparent !border-none" [rowsPerPageOptions]="[5, 10, 20]"></p-paginator>
          </div>
        </div>
      </section>

      <section class="bg-white border border-surface-200 rounded-2xl p-6 md:p-8 shadow-sm">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-1.5 h-8 bg-amber-500 rounded-full"></div>
          <h2 class="text-2xl font-bold text-surface-900 tracking-tight">Reseñas Publicadas</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div *ngFor="let review of foundReviews.reviews" class="p-5 rounded-xl border border-surface-200 bg-white hover:border-amber-400 transition-colors relative group">
            <div class="flex justify-between items-start mb-3">
              <div>
                <p class="font-bold text-surface-900 line-clamp-1">{{ review.productName }}</p>
                <p class="text-xs text-surface-500">{{ review.createdAt }}</p>
              </div>
              <p-button
                icon="pi pi-external-link"
                [routerLink]="['/product', review.productId]"
                [rounded]="true"
                [text]="true"
                size="small"
                styleClass="!text-surface-400 hover:!text-primary-500" />
            </div>

            <div class="mb-3 flex items-center gap-2 text-sm">
              <p-rating [ngModel]="review.rating" [readonly]="true"></p-rating>
              <span *ngIf="review.recommended" class="text-green-600 font-medium flex items-center gap-1"><i class="pi pi-thumbs-up"></i></span>
              <span *ngIf="!review.recommended" class="text-red-500 font-medium flex items-center gap-1"><i class="pi pi-thumbs-down"></i></span>
            </div>

            <p class="text-sm text-surface-600 italic bg-surface-50 p-3 rounded-lg border border-surface-100">
              "{{ review.text }}"
            </p>
          </div>
        </div>
        <div class="flex justify-center mt-6">
          <p-paginator (onPageChange)="onUserReviewsPageChange($event)" [first]="firstReview" [rows]="reviewsRows" [totalRecords]="foundReviews.totalReviews"
                       styleClass="!bg-transparent !border-none" [rowsPerPageOptions]="[5, 10, 20]"></p-paginator>
        </div>
      </section>

    </div>
  </div>
</div>

<app-footer></app-footer>
